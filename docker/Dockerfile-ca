FROM alpine:latest AS builder

# add dependencies
RUN apk update && apk add --no-cache \
    go curl git musl-dev

# build keybase binary
WORKDIR /go
ENV GOPATH=/go
ENV KEYBASE_VERSION=5.0.0
RUN go get -d -v github.com/keybase/client/go/keybase
RUN cd src/github.com/keybase/client/go/keybase && git checkout v$KEYBASE_VERSION
RUN go install -tags production github.com/keybase/client/go/keybase

# build kbfsfuse binary (we won't use FUSE but the bot needs KBFS for exchanging Team config files)
WORKDIR /go/src/github.com/keybase/client/go/kbfs/kbfsfuse
RUN go install 

WORKDIR /temp
COPY ./ /temp
RUN go mod download
RUN go build -o bin/keybaseca src/cmd/keybaseca/keybaseca.go

FROM alpine:latest

# add bash for entrypoint scripts, ssh for ssh-keygen used by the bot, sudo for stepping down to keybase user
RUN apk update && apk add --no-cache bash openssh sudo
WORKDIR /home/keybase

# add the keybase user
RUN adduser -s /bin/bash -h /home/keybase -D keybase

# copy the keybase binaries from previous build step 
COPY --from=builder /go/bin/keybase /usr/local/bin/
COPY --from=builder /go/bin/kbfsfuse /usr/local/bin/
COPY --from=builder /temp/bin/keybaseca /home/keybase/bin/keybaseca

# copy in entrypoint scripts and fix permissions
COPY ./docker/entrypoint-generate.sh .
COPY ./docker/entrypoint-server.sh .
RUN chown -R keybase:keybase /home/keybase

# this folder is needed for kbfsfuse
RUN mkdir /keybase && chown -R keybase:keybase /keybase

# Run container as root but only to be able to chown the Docker bind-mount, 
# then immediatetly step down to the keybase user via sudo in the entrypoint scripts
USER root