# See docker/Dockerfile-keybase
FROM keybase:latest

# Install go
USER root
RUN add-apt-repository ppa:gophers/archive -y
RUN apt-get update -y && apt-get install golang-1.11-go git sudo python3 python3-pip sudo -y
RUN pip3 install pytest requests

# Make it so the keybase user has passwordless sudo so it can move the keybase binary around
RUN echo "keybase ALL=(root) NOPASSWD:ALL" > /etc/sudoers.d/keybase && \
    chmod 0440 /etc/sudoers.d/keybase

# Install go dependencies (speeds up future builds)
COPY --chown=keybase go.mod .
COPY --chown=keybase go.sum .
RUN /usr/lib/go-1.11/bin/go mod download

COPY --chown=keybase ./ /home/keybase/
RUN /usr/lib/go-1.11/bin/go build -o bin/kssh src/cmd/kssh/kssh.go

USER root